import logging
import random
import asyncio
import json
from datetime import datetime, timedelta
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes,
    filters, ConversationHandler
)

# Enable logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Store participants info
participants = {}  # user_id: {'group': 'A' or 'B', 'username': str, 'start_date': date, 'tasks_sent': int}
admin_chat_id = "-4618714192"  # Replace with your actual admin chat ID

# Writing instructions
pre_task_message = """–ü–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º:
‚Ä¢ –ó–Ω–∞–π–¥—ñ—Ç—å —Ç–∏—Ö–µ –º—ñ—Å—Ü–µ, –¥–µ –í–∞—Å –Ω—ñ—Ö—Ç–æ –Ω–µ –ø–æ—Ç—É—Ä–±—É—î –ø—Ä–æ—Ç—è–≥–æ–º 15-30 —Ö–≤–∏–ª–∏–Ω. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ –ø–∞–ø—ñ—Ä —ñ —Ä—É—á–∫—É, –∞–±–æ –≤–∞—à –ø–ª–∞–Ω—à–µ—Ç —á–∏ –Ω–æ—É—Ç–±—É–∫ (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó, —É–≤—ñ–º–∫–Ω—ñ—Ç—å –∞–≤—ñ–∞—Ä–µ–∂–∏–º, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –≤—ñ–¥–≤–æ–ª—ñ–∫–∞–Ω—å).
‚Ä¢ –ü–æ—Å—Ç–∞–≤—Ç–µ —Ç–∞–π–º–µ—Ä –Ω–∞ 15 —Ö–≤–∏–ª–∏–Ω. –Ø–∫—â–æ –≤–≤–∞–∂–∞—î—Ç–µ –∑–∞ –ø–æ—Ç—Ä—ñ–±–Ω–µ, –í–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏ –ø–∏—Å–∞—Ç–∏ —ñ –ø—ñ—Å–ª—è –¥–∑–≤—ñ–Ω–∫–∞ —Ç–∞–π–º–µ—Ä–∞.
‚Ä¢ –ö–æ–ª–∏ –ø–æ—á–Ω–µ—Ç–µ –ø–∏—Å–∞—Ç–∏, –Ω–µ –∑—É–ø–∏–Ω—è–π—Ç–µ—Å—è, —Ö—ñ–±–∞ —â–æ –í–∞–º –±—É–¥–µ –∑–æ–≤—Å—ñ–º –≤–∞–∂–∫–æ –µ–º–æ—Ü—ñ–π–Ω–æ."""
post_task_message = """–ó–∞–∫—Ä–∏–π—Ç–µ –∑–æ—à–∏—Ç —á–∏ –¥–æ–∫—É–º–µ–Ω—Ç, –≤ —è–∫–æ–º—É –ø–∏—Å–∞–ª–∏, —ñ –≤—ñ–¥–∫–ª–∞–¥—ñ—Ç—å –π–æ–≥–æ. –Ø–∫—â–æ —Ç—Ä–µ–±–∞, –º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω –ø–æ—Å–∏–¥—ñ—Ç–∏, —â–æ–± –∑–∞—Å–ø–æ–∫–æ—ó—Ç–∏—Å—è. –Ø–∫—â–æ –≤–∞–º —Å—É–º–Ω–æ, —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∑–∞–∑–≤–∏—á–∞–π —Ü–µ –º–∏–Ω–∞—î –∑–∞ –∫—ñ–ª—å–∫–∞ –≥–æ–¥–∏–Ω, —è–∫ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Å—É–º–Ω–æ–≥–æ —Ñ—ñ–ª—å–º—É."""
group_instructions = {
    "A": """
–ó–æ—Å–µ—Ä–µ–¥—å—Ç–µ—Å—è —ñ –Ω–∞–ø–∏—à—ñ—Ç—å –ø—Ä–æ —Å–≤–æ—ó –Ω–∞–π–≥–ª–∏–±—à—ñ –¥—É–º–∫–∏ —Ç–∞ –ø–æ—á—É—Ç—Ç—è —â–æ–¥–æ —è–∫–æ—ó—Å—å –¥—É–∂–µ –≤–∞–∂–ª–∏–≤–æ—ó –µ–º–æ—Ü—ñ–π–Ω–æ—ó —Å–∏—Ç—É–∞—Ü—ñ—ó, –ø—Ä–æ–±–ª–µ–º–∏ —á–∏ –¥–æ—Å–≤—ñ–¥—É, —è–∫—ñ –≤–ø–ª–∏–Ω—É–ª–∏ –Ω–∞ –í–∞—Å —ñ –í–∞—à–µ –∂–∏—Ç—Ç—è. –í–∏ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç–∏ –ø—Ä–æ —Ç–µ –∂ —Å–∞–º–µ, —â–æ —ñ –º–∏–Ω—É–ª–æ–≥–æ —Ä–∞–∑—É, —á–∏ –æ–±—Ä–∞—Ç–∏ —â–æ—Å—å —ñ–Ω—à–µ. –ü–∏—à—É—á–∏, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ—Å—è —Ç–∞ –¥–æ–∑–≤–æ–ª—å—Ç–µ —Å–æ–±—ñ –∑–∞–Ω—É—Ä–∏—Ç–∏—Å—å —É –Ω–∞–π–≥–ª–∏–±—à—ñ –µ–º–æ—Ü—ñ—ó —Ç–∞ –¥—É–º–∫–∏. –û–ø–∏—à—ñ—Ç—å:
    ‚Ä¢ –§–∞–∫—Ç–∏ –ø—Ä–æ —Ü–µ–π –¥–æ—Å–≤—ñ–¥,
    ‚Ä¢ –ï–º–æ—Ü—ñ—ó, —è–∫—ñ –í–∏ —Ç–æ–¥—ñ –≤—ñ–¥—á—É–≤–∞–ª–∏, —Ç–∞ –µ–º–æ—Ü—ñ—ó, —è–∫—ñ –≤—ñ–¥—á—É–≤–∞—î—Ç–µ –∑–∞—Ä–∞–∑,
    ‚Ä¢ –ó–≤'—è–∑–∫–∏ –º—ñ–∂ —Ü–∏–º –¥–æ—Å–≤—ñ–¥–æ–º —Ç–∞ —ñ–Ω—à–∏–º–∏ –ø–æ–¥—ñ—è–º–∏ —É –≤–∞—à–æ–º—É –∂–∏—Ç—Ç—ñ.
–ü–æ—á–∞–≤—à–∏ –ø–∏—Å–∞—Ç–∏, –Ω–µ –∑—É–ø–∏–Ω—è–π—Ç–µ—Å—è. –ù–µ –∑–≤–∞–∂–∞–π—Ç–µ –Ω–∞ –ø–æ–º–∏–ª–∫–∏, –≥—Ä–∞–º–æ—Ç–Ω—ñ—Å—Ç—å, —á–∏ —Å—é–∂–µ—Ç —ñ—Å—Ç–æ—Ä—ñ–π, –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–ª–∞–¥—ñ—Ç—å —Å–≤—ñ–π –¥–æ—Å–≤—ñ–¥ –Ω–∞ –ø–∞–ø–µ—Ä—ñ. –Ø–∫—â–æ –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—è –Ω–æ–≤—ñ —ñ–¥–µ—ó, –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—é–π—Ç–µ —Ç–µ, —â–æ –≤–∂–µ –Ω–∞–ø–∏—Å–∞–ª–∏. –ü–∏—à—ñ—Ç—å –ø–æ–≤–Ω–∏–º–∏ —Ä–µ—á–µ–Ω–Ω—è–º–∏, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∏ –Ω–µ —ñ–¥–µ–∞–ª—å–Ω—ñ. –ù—ñ—Ö—Ç–æ, –∫—Ä—ñ–º –≤–∞—Å, –Ω–µ —á–∏—Ç–∞—Ç–∏–º–µ —Ü—å–æ–≥–æ.""",
    "B": """–û–±–µ—Ä—ñ—Ç—å –æ–¥–Ω—É —ñ–∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏—Ö —Ç–µ–º —Ç–∞ –ø–æ—á–∏–Ω–∞–π—Ç–µ –ø–∏—Å–∞—Ç–∏, –Ω–µ –≤—ñ–¥–≤–æ–ª—ñ–∫–∞—é—á–∏—Å—å.
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å, —â–æ –≤–∏ –∑—Ä–æ–±–∏–ª–∏ –∑ —Ç–æ–≥–æ —á–∞—Å—É, —è–∫ –ø—Ä–æ–∫–∏–Ω—É–ª–∏—Å—è —Å—å–æ–≥–æ–¥–Ω—ñ –≤—Ä–∞–Ω—Ü—ñ.
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –≤–∞—à—ñ –ø–ª–∞–Ω–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—ñ–π –¥–µ–Ω—å. 
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –æ—Å—Ç–∞–Ω–Ω—é –ø–æ–¥—ñ—é –∞–±–æ –∑–∞—Ö—ñ–¥, —è–∫—ñ –≤–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–ª–∏. 
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –±—É–¥—å-—è–∫–∏–π –ø—Ä–µ–¥–º–µ—Ç, —è–∫–∏–π –≤–∏ –±–∞—á–∏—Ç–µ –Ω–∞–≤–∫–æ–ª–æ —Å–µ–±–µ —á–∏ –≥–∞—Ä–Ω–æ –≤—ñ–¥–æ–º—É –≤–∞–º –±—É–¥—ñ–≤–ª—é. 
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–ø–∏—à—ñ—Ç—å —è–∫ –ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏ –∫–∞–≤—É –∑ –Ω—É–ª—è
                –í–∞–∂–ª–∏–≤–æ, —â–æ–± –≤–∏ –æ–ø–∏—Å—É–≤–∞–ª–∏ –ø–æ–¥—ñ—ó —Å–∞–º–µ —Ç–∞–∫, —è–∫ –≤–æ–Ω–∏ –≤—ñ–¥–±—É–≤–∞–ª–∏—Å—è. –ù–µ –∑–≥–∞–¥—É–π—Ç–µ –≤–ª–∞—Å–Ω—ñ –µ–º–æ—Ü—ñ—ó, –ø–æ—á—É—Ç—Ç—è —á–∏ –¥—É–º–∫–∏. –ù–∞–º–∞–≥–∞–π—Ç–µ—Å—è –±—É—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ–±‚Äô—î–∫—Ç–∏–≤–Ω–∏–º–∏.
                –ü—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –ø–æ—á–∞–ª–∏ –ø–∏—Å–∞—Ç–∏, –Ω–µ –∑—É–ø–∏–Ω—è–π—Ç–µ—Å—è. –ù–µ –∑–≤–∞–∂–∞–π—Ç–µ –Ω–∞ –ø–æ–º–∏–ª–∫–∏, –≥—Ä–∞–º–æ—Ç–Ω—ñ—Å—Ç—å, —á–∏ —Å—é–∂–µ—Ç —ñ—Å—Ç–æ—Ä—ñ–π. –Ø–∫—â–æ –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—è –Ω–æ–≤—ñ —ñ–¥–µ—ó, –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—é–π—Ç–µ —Ç–µ, —â–æ –≤–∂–µ –Ω–∞–ø–∏—Å–∞–ª–∏. –ü–∏—à—ñ—Ç—å –ø–æ–≤–Ω–∏–º–∏ —Ä–µ—á–µ–Ω–Ω—è–º–∏, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∏ –Ω–µ —ñ–¥–µ–∞–ª—å–Ω—ñ. –ù—ñ—Ö—Ç–æ, –∫—Ä—ñ–º –≤–∞—Å, –Ω–µ —á–∏—Ç–∞—Ç–∏–º–µ —Ü—å–æ–≥–æ."""
}

# Helper function to assign group and store new participant
async def register_user(user_id, username, context):
    if user_id not in participants:
        group = random.choice(['A', 'B'])
        participants[user_id] = {
            'group': group,
            'username': username,
            'start_date': datetime.now(),
            'tasks_sent': 0
        }
        await context.bot.send_message(chat_id=user_id, text=f"Welcome! You are in Group {group}.")
        await schedule_daily_tasks(user_id, context)
        logger.info(f"New user registered: {user_id} in Group {group}")
    else:
        await context.bot.send_message(chat_id=user_id, text="You are already registered.")

# Schedule 4 daily tasks
async def schedule_daily_tasks(user_id, context):
    group = participants[user_id]['group']
    for day in range(4):
        delay = timedelta(days=day)
        scheduled_time = datetime.now().replace(hour=9, minute=0, second=0, microsecond=0) + delay
        wait_seconds = (scheduled_time - datetime.now()).total_seconds()
        if wait_seconds < 0:
            wait_seconds = 0
        asyncio.create_task(send_task_after_delay(user_id, group, wait_seconds, context, day+1))

# Actual task sending
async def send_task_after_delay(user_id, group, delay_seconds, context, day):
    await asyncio.sleep(delay_seconds)
    try:
        await context.bot.send_message(chat_id=user_id, text=f"Day {day} of 4")
        await context.bot.send_message(chat_id=user_id, text=pre_task_message)
        await context.bot.send_message(chat_id=user_id, text=group_instructions[group])
        await context.bot.send_message(chat_id=user_id, text=post_task_message)
        participants[user_id]['tasks_sent'] += 1

        # Ask for task completion
        await asyncio.sleep(60)
        await context.bot.send_message(chat_id=user_id, text="Did you complete the task? (Yes/No)")
    except Exception as e:
        logger.error(f"Error sending task to {user_id}: {e}")

# /start handler
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await register_user(user.id, user.username, context)

# Load participants from file
def load_participants():
    try:
        with open('participants.json', 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

# Save participants to file
def save_participants(data):
    with open('participants.json', 'w') as f:
        json.dump(data, f)

# Assign task manually to participant
async def assign(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    if len(args) < 2:
        await update.message.reply_text("–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: /assign P1234 —Ç–µ–∫—Å—Ç_–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è")
        return

    participant_id = args[0]
    message_text = " ".join(args[1:])

    participants_data = load_participants()
    for chat_id, data in participants_data.items():
        if data["user_id"] == participant_id:
            await context.bot.send_message(chat_id=int(chat_id), text=message_text)
            await update.message.reply_text(f"‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –¥–æ {participant_id}")
            return

    await update.message.reply_text("‚ùå –£—á–∞—Å–Ω–∏–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π.")

# === REMOVE YOURSELF ===
async def clear_me(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id  # Get the chat ID of the user
    participants_data = load_participants()  # Load the participants data

    # Check if the user is in the participants list
    if str(chat_id) in participants_data:
        del participants_data[str(chat_id)]  # Remove the participant
        save_participants(participants_data)  # Save the updated data back to the file
        await update.message.reply_text("‚úÖ –í–∏ –±—É–ª–∏ –≤–∏–¥–∞–ª–µ–Ω—ñ –∑ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.")
    else:
        await update.message.reply_text("‚ùå –í–∏ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —É —Å–∏—Å—Ç–µ–º—ñ.")

# === BROADCAST TO MULTIPLE USERS ===
async def broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if str(update.effective_chat.id) != admin_chat_id:
        return  # Only admin can broadcast
    
    if len(context.args) < 2:
        await update.message.reply_text("–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: /broadcast P1234,P5678 —Ç–µ–∫—Å—Ç_–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è")
        return

    # First argument is comma-separated list of participant IDs
    participant_ids = context.args[0].split(',')
    message_text = " ".join(context.args[1:])
    
    participants_data = load_participants()
    delivery_status = {}
    
    # Send messages and track status for each participant
    for chat_id, data in participants_data.items():
        if data["user_id"] in participant_ids:
            try:
                await context.bot.send_message(chat_id=int(chat_id), text=message_text)
                delivery_status[data["user_id"]] = "‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"
            except Exception as e:
                delivery_status[data["user_id"]] = f"‚ùå –ü–æ–º–∏–ª–∫–∞: {str(e)}"
    
    # Create detailed report
    status_report = "üì¨ –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏:\n\n"
    for p_id in participant_ids:
        status = delivery_status.get(p_id, "‚ùå –£—á–∞—Å–Ω–∏–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—ñ")
        status_report += f"{p_id}: {status}\n"
    
    await update.message.reply_text(status_report)

# === BOT APP ===
def main():
    app = ApplicationBuilder().token('BOT_TOKEN').build()

    # Add handlers
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("assign", assign))  # The assign command
    app.add_handler(CommandHandler("clearme", clear_me))  # Add the clear_me handler
    app.add_handler(CommandHandler("broadcast", broadcast))  # Add the broadcast handler
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))  # Handling other messages

# Main function to run the bot
if __name__ == '__main__':
    import os
    TOKEN = os.getenv("BOT_TOKEN")
    application = ApplicationBuilder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))

    logger.info("Bot started.")
    application.run_polling()
